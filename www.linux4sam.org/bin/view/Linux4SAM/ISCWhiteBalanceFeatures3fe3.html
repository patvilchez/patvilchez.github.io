<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">

<!-- Mirrored from www.linux4sam.org/bin/view/Linux4SAM/ISCWhiteBalanceFeatures?skin=print.myskin by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 05 Jul 2021 19:11:13 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=iso-8859-1" /><!-- /Added by HTTrack -->
<head>
<link rel="stylesheet" href="https://www.linux4sam.org/pub/TWiki/RedDotPlugin/style.css" type="text/css" media="all" />
<script type="text/javascript" src="https://www.linux4sam.org/pub/TWiki/JQueryPlugin/jquery.js"></script>
<script type="text/javascript" src="https://www.linux4sam.org/pub/TWiki/JQueryPlugin/jquery-migrate.js"></script>
<link rel="stylesheet" href="https://www.linux4sam.org/pub/TWiki/JQueryPlugin/jquery-all.css" type="text/css" media="all" />
<script type="text/javascript" src="https://www.linux4sam.org/pub/TWiki/JQueryPlugin/jquery-all.js"></script>
<title>TWiki &middot; Linux4SAM &middot; ISCWhiteBalanceFeatures &middot; (printable)</title>
<base  />
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta http-equiv="Content-Style-Type" content="text/css" /> 
<meta name="generator" content="TWiki/NatSkin" /> 
<link rel="icon" href="https://www.linux4sam.org/pub/Linux4SAM/WebPreferences/favicon.ico" type="image/x-icon" /> 
<link rel="shortcut icon" href="https://www.linux4sam.org/pub/Linux4SAM/WebPreferences/favicon.ico" type="image/x-icon" />
<!-- 

  Enable the line below when firefox has fixed printing of pages
  that import css. See https://bugzilla.mozilla.org/show_bug.cgi?id=154892 

%GETSKINSTYLE% 

-->
<!-- template javascript -->

<!-- template javascript -->
<style type="text/css">
.natFeedIcon,
.blogEntryFeed,
.blogNavigation,
.blogAddComment {
  display:none;
}
/*
.natExternalLink:after {
  content: " (" attr(href) ") ";
}
*/
%WEBCOMPONENT{"WebCss"}%
</style>
</head>
<body class="natBody natBodyPrint">
<div class="natBodyContents">
  <div class="natMiddle natMain">
	 <div class="natMainContents">
<p /><h1><a name="Image_Sensor_Controller_White_ba"></a>  Image Sensor Controller White balance features </h1>
<p />
<div class="twikiToc"> <ul>
<li> <a href="index3fe3.html?skin=print.myskin#Introduction"> Introduction</a>
</li> <li> <a href="index3fe3.html?skin=print.myskin#How_to_adjust_colors"> How to adjust colors</a>
</li> <li> <a href="index3fe3.html?skin=print.myskin#Using_histogram_and_Grey_world_a"> Using histogram and Grey world and stretching algorithm</a>
</li> <li> <a href="index3fe3.html?skin=print.myskin#Support_inside_the_atmel_isc_dri"> Support inside the atmel_isc driver</a> <ul>
<li> <a href="index3fe3.html?skin=print.myskin#Auto_white_balance_feature"> Auto white balance feature</a>
</li> <li> <a href="index3fe3.html?skin=print.myskin#One_time_white_balance_adjustmen"> One time white balance adjustment</a>
</li></ul> 
</li> <li> <a href="index3fe3.html?skin=print.myskin#Example"> Example</a>
</li></ul> 
</div>
<p />
<hr />
<p />
These features are available and apply only for the <a class="twikiLink" href="UsingISC.html">Atmel Image sensor controller</a> . They do not apply for the <a class="twikiLink" href="UsingIsi6.html">Image Sensor Interface</a>.
<p />
<h1><a name="Introduction"></a> Introduction </h1>
<p />
White balance is a type of adjustment that will modify the colors in an image such that the colors are adjusted to the type (temperature) of the ambient light of the scenery.
<p />
Our human eye automatically adjusts to the ambient light, such that the colors look natural in our brain. For example, if we look in neon light, everything is more blueish, but, our brain adapts and sees the "red" as "red", even if the color is actually different.
<p />
The sensor cannot do the same adjustment. The sensor will have some kind of default settings for the colors, which can be changed inside the ISC to adapt to the ambient light. The purpose of the white balance feature is to automatically adapt to every possible light scenario.
<p />
Light sources have a different color temperature , starting from around 2500K up to 7000K. The lower temperature corresponds to yellowish/reddish type of light, while higher temperature corresponds to blueish light. This actually comes from the temperature of the light bulb that will light the scenery.
<p />
<h1><a name="How_to_adjust_colors"></a> How to adjust colors </h1>
For RAW bayer sensors, we have 4 color channels: Red, Green-on-red, Blue, Green-on-blue, which we will name R, GR, B, GB. This is how Bayer format works. So we have 4 different color channels, one red, one blue and two green.
Each of these channels can be adjusted in terms of gain and offset. The Gain is a multiplication factor while the offset is an addition factor.
<p />
The ISC allows us to program these values and adjust in hardware each color channel of the BAYER format.
<p />
<img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/warning.gif" width="16" height="16" alt="Warning, important" title="Warning, important" border="0" /> White balance adjustment <strong>only works if the sensor is in RAW BAYER mode</strong>. If the sensor will output another format (YUYV or RGB565 for example), White balance algorithms cannot be applied.
<p />
<h1><a name="Using_histogram_and_Grey_world_a"></a> Using histogram and Grey world and stretching algorithm </h1>
To adjust the gains/offsets for our color channels, we will use the following axiom: If we picture a grey colored scenery, regardless of the ambient lighting, the average color must be grey. Grey means that all the 4 channels have the same weight inside the average of the scenery. If one color dominates, then we have a wrong white balance situation: grey is more reddish , blueish, greenish than it's supposed to be: that is, grey.
<p />
To achieve this, we need to take a sample photo of either a grey card/color checker card, or of a scenery that on average is grey (meaning that there is no dominant color, it does not work if we picture a red box for example).
<p />
Best results are achieved using a grey card or color checker card (which averages on grey if pictured as a whole).
<p />
A color checker card can be seen below:
<p />
     <img src="../../../pub/Linux4SAM/ISCWhiteBalanceFeatures/xrite-msccc_1.jpg" alt="xrite-msccc_1.jpg" width="150" height="100" />
<p />
The histogram will help us with computing the colors: the histogram will add up all the pixels for each channel, with their corresponding pixel value. This means that the histogram will count how much red is in the image, how much blue is in the image, etc.
<p />
After we obtain the histogram, we need to compute the gain to adjust the channels which are lower. We will consider the green channels as fixed and compute gains for red and blue channels.
<p />
Histogram stretching will apply additional gain/offset to make the histogram stretch over all pixel values, to avoid dead areas in the histogram: if that would happen, would mean that instead of 8bit or 10bit resolution for the colors, we have less, which is not desired.
<p />
<h1><a name="Support_inside_the_atmel_isc_dri"></a> Support inside the atmel_isc driver </h1>
<h2><a name="Auto_white_balance_feature"></a> Auto white balance feature </h2>
By default, the ISC driver will do "auto white balance" . This means that every 4 frames, while streaming is running, the driver will adjust the white balance to the scenery in front of the sensor.
<p />
<img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/hand.gif" width="16" height="16" alt="Pointing hand" title="Pointing hand" border="0" /> Advantages of this method are: if we change the scenery, nothing to be done. If we have a good grey scenery, white balance looks good. Also, user does not need to do anything.</br>
<img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/hand.gif" width="16" height="16" alt="Pointing hand" title="Pointing hand" border="0" /> Disadvantages: every time the scenery changes, if grey is no longer dominant, colors will be adjusted to compensate in a bad way: if we picture a red image, the algorithm will auto adjust to make this red look in fact grey (Grey world assumption).
<p />
The auto white balance status can be checked using v4l2-ctl :
<pre>
User Controls

                     brightness 0x00980900 (int)    : min&#61;-1024 max&#61;1023 step&#61;1 default&#61;0 value&#61;0 flags&#61;slider
                       contrast 0x00980901 (int)    : min&#61;-2048 max&#61;2047 step&#61;1 default&#61;256 value&#61;256 flags&#61;slider
        white&#95;balance&#95;automatic 0x0098090c (bool)   : default&#61;1 value&#61;1
               do&#95;white&#95;balance 0x0098090d (button) : flags&#61;inactive, write-only, execute-on-write
                          gamma 0x00980910 (int)    : min&#61;0 max&#61;2 step&#61;1 default&#61;2 value&#61;2 flags&#61;slider
</pre>
To disable auto white balance feature:
<pre>
# v4l2-ctl --set-ctrl&#61;white&#95;balance&#95;automatic&#61;0
</pre>
When the auto white balance is disabled, the gains/offsets are static and not changed.
To enable the auto white balance:
<pre>
# v4l2-ctl --set-ctrl&#61;white&#95;balance&#95;automatic&#61;1
</pre>
<p />
<p />
<h2><a name="One_time_white_balance_adjustmen"></a> One time white balance adjustment </h2>
This feature means that the user <strong>can do a one time adjustment when the scenery respects the Grey world assumption and set in stone the coefficients</strong>.
<p />
The feature is a button-like control: give the command, and the white balance is adjusted.
<p />
If this is done while auto white balance is enabled, it will work, of course, but the auto white balance will adjust again in the next frames, so we cannot obtain anything useful.
<p />
To try this feature, <strong>the streaming must be enabled</strong>. The sensor must be streaming data . This is needed because we need to compute the histogram, and we need data for it (a real frame from sensor). If the streaming is not enabled, the command will be ignored and no white balance adjustment will occur. Thus, if streaming is disabled, the control will appear as <em>inactive</em> in the list of controls.
<p />
The recommended way to test this feature is: </br> <ol>
<li> Enable streaming first (this can be done with gstreamer for example, either put the image on the LCD, or to a <em>fakesink</em> ). When streaming is enabled we can see the control is now active: <pre>
User Controls

                     brightness 0x00980900 (int)    : min&#61;-1024 max&#61;1023 step&#61;1 default&#61;0 value&#61;0 flags&#61;slider
                       contrast 0x00980901 (int)    : min&#61;-2048 max&#61;2047 step&#61;1 default&#61;256 value&#61;256 flags&#61;slider
        white&#95;balance&#95;automatic 0x0098090c (bool)   : default&#61;1 value&#61;1
               do&#95;white&#95;balance 0x0098090d (button) : write-only, execute-on-write
                          gamma 0x00980910 (int)    : min&#61;0 max&#61;2 step&#61;1 default&#61;2 value&#61;2 flags&#61;slider
</pre>
</li> <li> Disable the auto white balance feature (if enabled) <pre>
# v4l2-ctl --set-ctrl&#61;white&#95;balance&#95;automatic&#61;0
</pre>
</li> <li> Carefully place the color checker card in front of the camera such that <strong>the whole checker card and nothing but the checker card</strong> is captured in the frame.
</li> <li> Issue: <pre>
# v4l2-ctl --set-ctrl&#61;do&#95;white&#95;balance&#61;1
</pre>
</li> <li> White balance one time adjustment is completed once the Linux kernel informs you: <pre>
&#91; 5566.890000] atmel&#95;isc f0008000.isc: Completed one time white-balance adjustment.
</pre>
</li></ol> 
<p />
<img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/hand.gif" width="16" height="16" alt="Pointing hand" title="Pointing hand" border="0" /> Advantages of this method: Best possible white balance for the given light is done. After the adjustment, in the same light, colors are perfectly adjusted to the light.</br>
<img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/hand.gif" width="16" height="16" alt="Pointing hand" title="Pointing hand" border="0" /> Disadvantages: Need a color checker card. Need the user to place the color checker card in front of the sensor and give a command. Need to repeat the operation after each reboot or scenery light change.
<p />
<img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/hand.gif" width="16" height="16" alt="Pointing hand" title="Pointing hand" border="0" />  Note: The coefficients are not saved after board reset.
<p />
<h1><a name="Example"></a> Example </h1>
<p />
Below we can see a photo before and after white balance adjustment:
<p />
<p />
     <img src="../../../pub/Linux4SAM/ISCWhiteBalanceFeatures/8RGGB_bef.jpg" alt="8RGGB_bef.jpg" width="640" height="270" />
     <img src="../../../pub/Linux4SAM/ISCWhiteBalanceFeatures/8RGGB.wb..jpg" alt="8RGGB.wb..jpg" width="640" height="270" /> 
	 </div>
  <div class="natMainFooterContents">
	 <div class="natTopicAttachments"> <div class="twikiAttachments">
<table border="1" cellpadding="0" cellspacing="0" class="twikiTable" id="table1" rules="all">
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<th bgcolor="#687684" class="twikiTableCol0 twikiFirstCol" valign="top"> <a href="ISCWhiteBalanceFeatures02cd.html?skin=print.myskin;sortcol=0;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">I</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol1" valign="top"> <a href="ISCWhiteBalanceFeaturescc4a.html?skin=print.myskin;sortcol=1;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Attachment</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol2" valign="top"> <a href="ISCWhiteBalanceFeaturesc02a.html?skin=print.myskin;sortcol=2;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Action</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol3" valign="top"> <a href="ISCWhiteBalanceFeatures101b.html?skin=print.myskin;sortcol=3;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Size</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol4" valign="top"> <a href="ISCWhiteBalanceFeaturesda64.html?skin=print.myskin;sortcol=4;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Date</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol5" valign="top"> <a href="ISCWhiteBalanceFeatures0539.html?skin=print.myskin;sortcol=5;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Who</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol6 twikiLastCol" valign="top"> <a href="ISCWhiteBalanceFeaturesf3f9.html?skin=print.myskin;sortcol=6;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Comment</font></a> </th>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> <img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/jpg.gif" width="16" height="16" alt="JPEG" title="JPEG" border="0" /><span class="twikiHidden">jpg</span> </td>
<td bgcolor="#ffffff" class="twikiTableCol1" valign="top"> <a href="../../../pub/Linux4SAM/ISCWhiteBalanceFeatures/8RGGB.wb..jpg">8RGGB.wb..jpg</a> </td>
<td bgcolor="#ffffff" class="twikiTableCol2" valign="top"> <a href="https://www.linux4sam.org/bin/attach/Linux4SAM/ISCWhiteBalanceFeatures?filename=8RGGB.wb..jpg;revInfo=1" title="change, update, previous revisions, move, delete..." rel="nofollow">manage</a> </td>
<td align="right" bgcolor="#ffffff" class="twikiTableCol3" valign="top"> 154.9&nbsp;K </td>
<td bgcolor="#ffffff" class="twikiTableCol4" valign="top"> <span class="twikiNoBreak">2019-04-23 - 12:13</span> </td>
<td bgcolor="#ffffff" class="twikiTableCol5" valign="top"> <a class="twikiLink" href="https://www.linux4sam.org/bin/login/Main/EugenHristev?origurl=/bin/view/Main/EugenHristev">EugenHristev</a> </td>
<td bgcolor="#ffffff" class="twikiTableCol6 twikiLastCol" valign="top"> &nbsp; </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> <img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/jpg.gif" width="16" height="16" alt="JPEG" title="JPEG" border="0" /><span class="twikiHidden">jpg</span> </td>
<td bgcolor="#edf4f9" class="twikiTableCol1" valign="top"> <a href="../../../pub/Linux4SAM/ISCWhiteBalanceFeatures/8RGGB_bef.jpg">8RGGB_bef.jpg</a> </td>
<td bgcolor="#edf4f9" class="twikiTableCol2" valign="top"> <a href="https://www.linux4sam.org/bin/attach/Linux4SAM/ISCWhiteBalanceFeatures?filename=8RGGB_bef.jpg;revInfo=1" title="change, update, previous revisions, move, delete..." rel="nofollow">manage</a> </td>
<td align="right" bgcolor="#edf4f9" class="twikiTableCol3" valign="top"> 148.6&nbsp;K </td>
<td bgcolor="#edf4f9" class="twikiTableCol4" valign="top"> <span class="twikiNoBreak">2019-04-23 - 12:13</span> </td>
<td bgcolor="#edf4f9" class="twikiTableCol5" valign="top"> <a class="twikiLink" href="https://www.linux4sam.org/bin/login/Main/EugenHristev?origurl=/bin/view/Main/EugenHristev">EugenHristev</a> </td>
<td bgcolor="#edf4f9" class="twikiTableCol6 twikiLastCol" valign="top"> &nbsp; </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol twikiLast" valign="top"> <img src="https://www.linux4sam.org/pub/TWiki/TWikiDocGraphics/jpg.gif" width="16" height="16" alt="JPEG" title="JPEG" border="0" /><span class="twikiHidden">jpg</span> </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLast" valign="top"> <a href="../../../pub/Linux4SAM/ISCWhiteBalanceFeatures/xrite-msccc_1.jpg">xrite-msccc_1.jpg</a> </td>
<td bgcolor="#ffffff" class="twikiTableCol2 twikiLast" valign="top"> <a href="https://www.linux4sam.org/bin/attach/Linux4SAM/ISCWhiteBalanceFeatures?filename=xrite-msccc_1.jpg;revInfo=1" title="change, update, previous revisions, move, delete..." rel="nofollow">manage</a> </td>
<td align="right" bgcolor="#ffffff" class="twikiTableCol3 twikiLast" valign="top"> 181.5&nbsp;K </td>
<td bgcolor="#ffffff" class="twikiTableCol4 twikiLast" valign="top"> <span class="twikiNoBreak">2019-04-23 - 11:55</span> </td>
<td bgcolor="#ffffff" class="twikiTableCol5 twikiLast" valign="top"> <a class="twikiLink" href="https://www.linux4sam.org/bin/login/Main/EugenHristev?origurl=/bin/view/Main/EugenHristev">EugenHristev</a> </td>
<td bgcolor="#ffffff" class="twikiTableCol6 twikiLastCol twikiLast" valign="top"> &nbsp; </td>
</tr></table>
</div> </div>
  </div>
  </div>
</div>
</body>

<!-- Mirrored from www.linux4sam.org/bin/view/Linux4SAM/ISCWhiteBalanceFeatures?skin=print.myskin by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 05 Jul 2021 19:11:28 GMT -->
</html>
<!-- template: view.print.nat.tmpl -->
<style>
h1,h1 span{color:#000;}
</style>